<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Block-Construction/Block-Sync">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.1">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Manifold Finance Knowledgebase RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Manifold Finance Knowledgebase Atom Feed">





<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><title data-rh="true">sync and the merge | Manifold Finance Knowledgebase</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://kb.manifoldfinance.com/docs/Block-Construction/Block-Sync"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="sync and the merge | Manifold Finance Knowledgebase"><meta data-rh="true" name="description" content="source//raw.githubusercontent.com/fjl/p2p-drafts/master/merge-sync/merge-sync.md"><meta data-rh="true" property="og:description" content="source//raw.githubusercontent.com/fjl/p2p-drafts/master/merge-sync/merge-sync.md"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kb.manifoldfinance.com/docs/Block-Construction/Block-Sync"><link data-rh="true" rel="alternate" href="https://kb.manifoldfinance.com/docs/Block-Construction/Block-Sync" hreflang="en"><link data-rh="true" rel="alternate" href="https://kb.manifoldfinance.com/docs/Block-Construction/Block-Sync" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.191b2cdf.css">
<link rel="preload" href="/assets/js/runtime~main.e43a89e6.js" as="script">
<link rel="preload" href="/assets/js/main.387e3fc9.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Manifold Finance logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="Manifold Finance logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Manifold Finance</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">KB</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Block-Construction">Block Construction</a><a class="navbar__item navbar__link" href="/docs/Rpc/ref-json-rpc">RPC Methods</a><a class="navbar__item navbar__link" href="/docs/Protocol/protocol-backbonev01">Network Specification</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Ethereum</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/manifoldfinance/kb" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://t.me/manifoldfinance" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://forums.manifoldfinance.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Forums<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_Pkmr"><kbd class="searchHint_iIMx">ctrl</kbd><kbd class="searchHint_iIMx">K</kbd></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Manifold Finance Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/general---overview">General - Overview</a><button aria-label="Toggle the collapsible sidebar category &#x27;General - Overview&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/block-construction">Block Construction</a><button aria-label="Toggle the collapsible sidebar category &#x27;Block Construction&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Block-Construction/blockconstruction-intro">Block Construction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Block-Construction/">PBS Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Block-Construction/block-rewards">Rewards and Fee Recipient</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Block-Construction/blockconstruction-policies">Network Filtering and Policies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Block-Construction/blockconstruction-message-ordering">Block Construction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Block-Construction/Block-Sync">sync and the merge</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Block-Construction/Find-Safe-Head">Finding the Safe Head</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Block-Construction/Single-Slot-Finality">Single Slot Finality</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/how-to-guides">How-to Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;How-to Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/community">Community</a><button aria-label="Toggle the collapsible sidebar category &#x27;Community&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/contracts---router">Contracts - Router</a><button aria-label="Toggle the collapsible sidebar category &#x27;Contracts - Router&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/tutorials">Tutorials</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tutorials&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/developers">Developers</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developers&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/protocol">Protocol</a><button aria-label="Toggle the collapsible sidebar category &#x27;Protocol&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/fold-token">FOLD Token</a><button aria-label="Toggle the collapsible sidebar category &#x27;FOLD Token&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/switchboard">Switchboard</a><button aria-label="Toggle the collapsible sidebar category &#x27;Switchboard&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/rpc--api">RPC &amp; API</a><button aria-label="Toggle the collapsible sidebar category &#x27;RPC &amp; API&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/reference">Reference</a><button aria-label="Toggle the collapsible sidebar category &#x27;Reference&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Strategies/strat-sushiswap">Strategies</a></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/block-construction"><span itemprop="name">Block Construction</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">sync and the merge</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Sync &amp; The Merge</h1><blockquote><p><a href="https://raw.githubusercontent.com/fjl/p2p-drafts/master/merge-sync/merge-sync.md" target="_blank" rel="noopener noreferrer">source: https://raw.githubusercontent.com/fjl/p2p-drafts/master/merge-sync/merge-sync.md</a></p></blockquote><p>*<strong>*Warning!**</strong> This is a work in progress. After initial review, it seems that the sync scheme presented here will not work without modifications. See end of document for known issues and potential solutions. For now, you should read this as a description of the ideal sync algorithm, keeping in mind that it will become more complicated later.</p><p>In this document, we (the geth team) present our ideas for implementing chain synchronization on the merged eth1 + eth2 chain. After the merge event, eth1 and eth2 clients run in tandem. The eth2 client maintains the connection to the beacon chain and performs fork choice. The eth1 client, a.k.a. the &#x27;execution layer&#x27;, receives block data from the eth2 client, executes/verifies it and maintains the application state.</p><p>The interface that eth2 and eth1 use to communicate is uni-directional: all cross-client communication is initiated by eth2, and happens in the form of requests. Eth1 responds to requests, but cannot request any information from eth2.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="definitions">Definitions<a class="hash-link" href="#definitions" title="Direct link to heading">​</a></h2><p>In the text below, we refer to beacon chain blocks as b<sub>x</sub>. We also assume that the beacon chain begins at block b<sub>W</sub>, a recent checkpoint, which must be a block after the merge event. There is a direct correspondence between beacon chain blocks and block data of the execution layer: for every beacon block b<sub>x</sub> (for x &gt;= w), a corresponding execution-layer block B<sub>x</sub> also exists. Additionally, every execution-layer block B<sub>x</sub> contains its block header H<sub>x</sub>.</p><p>Please note that this document is an abstract description of the sync algorithm and isn&#x27;t concerned with the real APIs that eth1 and eth2 nodes will use to communicate. We assume that eth2 can invoke the following operations in the eth1 client:</p><ul><li><strong>checkpoint(H):</strong> notifies the eth1 client about a checkpoint header. This has no useful response.</li><li><strong>final(B):</strong> submits a finalized block. The eth1 client can answer &#x27;old&#x27;, &#x27;syncing&#x27;, invalid(B) or synced(B). Note that we assume this will be called for all finalized blocks, not just on epoch boundaries.</li><li><strong>proc(B):</strong> submits a non-finalized block for EVM processing. The eth1 client can respond with &#x27;valid&#x27;, &#x27;invalid&#x27; or &#x27;syncing&#x27;.</li></ul><p>In diagrams, not all responses to eth2 requests are shown.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="sync">Sync<a class="hash-link" href="#sync" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="eth2-perspective">eth2 perspective<a class="hash-link" href="#eth2-perspective" title="Direct link to heading">​</a></h3><p>This section explains the sync procedure from the eth2 client point-of-view.</p><p>When the eth2 client starts, it is initialized with a &#x27;weak subjectivity checkpoint&#x27; containing the beacon chain state of a historical block b<sub>W</sub>. The checkpoint also contains the execution-layer block header H<sub>W</sub>. On startup, H<sub>W</sub> is immediately relayed to the eth1 client (1).</p><p>To sync, the eth2 client must first process the beacon chain optimistically<!-- -->—<!-- -->without accessing application state<!-- -->—<!-- -->up to the latest finalized block b<sub>F</sub> (2). When block b<sub>F</sub> is reached, the eth2 client starts eth1 sync by providing the execution-layer block B<sub>F</sub> to the eth1 client (3).</p><p><img loading="lazy" alt="img" src="/assets/images/beacon-1-f91d2bb2d8e892ff33ae3dc13d0ee56e.svg" title="Syncing up to the latest finalized block" width="730" height="156" class="img_ev3q"></p><p>The eth2 client keeps following the beacon chain until eth1 sync completes, and keeps submitting finalized blocks to the eth1 client. This means it should repeat step (3) for every new finalized block.</p><p>Eth1 sync will usually take quite a bit of time to complete. While it is syncing, the beacon chain advances by t blocks to the latest finalized block b<sub>F+t</sub>.</p><p>The eth1 client signals that it is done by responding with synced(B<sub>F+t</sub>) (4). The application state of B<sub>F+t</sub> is now available and the eth2 client can perform additional cross-validation against this state. For example, it could read the deposit contract here.</p><p>The eth2 client should now submit the execution-layer block data of all non-finalized beacon blocks to the eth1 client for processing (5). The sync procedure completes when the current head block b<sub>H</sub> is reached.</p><p><img loading="lazy" alt="img" src="/assets/images/beacon-2-d79dd254057c8889c537a46a4478a739.svg" title="Processing non-finalized blocks" width="730" height="156" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="eth1-perspective">eth1 perspective<a class="hash-link" href="#eth1-perspective" title="Direct link to heading">​</a></h3><p>Upon startup, the eth1 client first waits for a checkpoint header H<sub>W</sub> from the eth2 client. H<sub>W</sub> must be a descendant of the genesis block B<sub>G</sub>.</p><p>Sync begins when the finalized block B<sub>F</sub> is received. This block is assumed to be valid. Furthermore, it is assumed that B<sub>F</sub> is a descendant of B<sub>W</sub>.</p><p>While the chain is downloading/processing, the eth1 client receives further notifications about newly-finalized blocks in range B<sub>F+1</sub>…<!-- -->B<sub>F+t</sub>. During sync, at latest finalized block B<sub>f</sub>, clients must handle final(B<sub>x</sub>) as follows:</p><ul><li>for x &lt;= f, the response is &#x27;old&#x27; if the block is known, or invalid(B<sub>x</sub>) if the block is unknown.</li><li>for x &gt; f+1, attempting to finalize an unknown future block, sync is restarted on B<sub>x</sub> and the response is &#x27;syncing&#x27;.</li><li>for x == f+1, the block is appended to the database. If the client is still busy syncing to B<sub>f</sub>, the response is &#x27;syncing&#x27;. If the client is done syncing to block B<sub>f</sub>, it processes block B<sub>x</sub> and outputs synced(B<sub>x</sub>) or invalid(B<sub>x</sub>).</li></ul><p>When proc() is received during sync, the response is &#x27;syncing&#x27;.</p><p><img loading="lazy" alt="img" src="/assets/images/eth1-1-4afd6760446e444546734d79d5ed531b.svg" title="Downloading the finalized eth1 chain" width="730" height="173" class="img_ev3q"></p><p>After starting sync on B<sub>F</sub> (1), the eth1 client first downloads the chain of block headers down from H<sub>F</sub>, following parent hashes (2). Headers are written to the database. The header chain must contain the checkpoint header H<sub>W</sub>, and sync fails if a different header is encountered at the same block number. This sanity check exists to ensure that the chain is valid without having to sync all the way back to the genesis block.</p><p>When the genesis header H<sub>G</sub> is reached, block body data can be downloaded (3). There are two ways to do this:</p><ul><li><p>The client can perform &#x27;full sync&#x27;, downloading blocks and executing their state transitions. This recreates the application state incrementally up to the latest block. Sync is complete when the latest finalized block B<sub>F+t</sub> has been processed.</p></li><li><p>The client can perform state synchronization by downloading the blocks B<sub>G+1</sub>…<!-- -->B<sub>F</sub> and their application state without EVM execution. This is expected to be faster than full sync, and is equally secure because the state root of B<sub>F</sub> was finalized by eth2. The state download can happen concurrently with steps (2) and (3).</p><p>The peer-to-peer network can only provide the state of very recent blocks. Since it is expected that the state of B<sub>F</sub> will gradually become unavailable as the chain advances, the client must occasionally re-target its state sync to a more recent &#x27;pivot block&#x27;. Conveniently, the newly-finalized blocks B<sub>F+1</sub>…<!-- -->B<sub>F+t</sub> received from eth2 can be used for this purpose. You can read more about the pivot block in the <a href="https://github.com/ethereum/devp2p/blob/master/caps/snap.md#synchronization-algorithm" target="_blank" rel="noopener noreferrer">snap sync protocol specification</a>.</p></li></ul><p>After reporting sync completion of B<sub>F+t</sub> to the eth2 client (4), the execution layer is done and switches to its ordinary mode of operation: individual blocks are received from the eth2 client, the blocks are processed, and their validity reported back to the eth2 client. Reorgs of non-finalized blocks may also be triggered after sync has completed. Reorg handling is discussed later in this document.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="handling-restarts-and-errors">Handling restarts and errors<a class="hash-link" href="#handling-restarts-and-errors" title="Direct link to heading">​</a></h3><p>The above description of sync focuses on a single sync cycle. In order to be robust against failures, and to handle client restarts, clients must be able to perform multiple sync cycles with an initialized database. The interface between eth2 and eth1 makes this easy for eth2 because it is uni-directional: When eth2 restarts, it can simply perform the usual request sequence and expect that the eth1 client will reset itself to the correct state.</p><p>When eth1 receives note of a finalized block B<sub>F</sub>, there are two possibilities: if the block already exists in the local chain, and its application state is also available, sync isn&#x27;t necessary. If the finalized block is unknown, the eth1 client should restart sync at step (1), downloading parent headers in reverse. If the block is known but its state is unavailable, the client should attempt to synchronize the state of B<sub>F</sub> or, when configured for full sync, attempt to process blocks forward up to B<sub>F</sub> from the most recent available state.</p><p>For eth1 sync restarts, block data persisted to the database by previous sync cycles can be reused. Whenever a finalized header H<sub>x</sub> is to be fetched from the network, the client should check if the database already contains block data at the same block height x. If the local database contains a finalized header at height x, but its hash does not match H<sub>x</sub>, the client should delete the header and all block data associated with it. If the hash of the previously-stored header does match H<sub>x</sub>, sync can skip over the chain of locally available headers and resume sync at the height of the next unavailable header.</p><p>To make this skipping operation work efficiently, we recommend that clients store and maintain &#x27;marker&#x27; records containing information about previously-stored contiguous chain segments. When sync starts at H<sub>F</sub>, the client stores marker M<sub>F</sub> = F. As subsequent headers H<sub>x</sub> are downloaded, the marker is updated to M<sub>F</sub> = x. Similarly, as the chain is extended forward by concurrent calls to final(B<sub>F+1</sub>), the marker also moves forward, i.e. M<sub>F+1</sub> = M<sub>F</sub> and M<sub>F</sub> is deleted.</p><p>Now assume that the sync cycle terminates unexpectedly at block height s. When the next cycle starts, it first loads marker records of previous sync cycles. As the new cycle progresses downloading parents, it will eventually cross the previous height F. If the header hash matches the previously-stored header H<sub>F</sub>, the marker can be used to resume sync at height s where the first cycle left off.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="reorg-processing-and-state-availability">Reorg processing and state availability<a class="hash-link" href="#reorg-processing-and-state-availability" title="Direct link to heading">​</a></h2><p>It is common knowledge that the application state of eth1 can become quite large. As such, eth1 clients usually only store exactly one full copy of this state.</p><p>In order to make state synchronization work, the application state of the latest finalized block B<sub>F</sub> must be available for download. We therefore recommend that clients which store exactly one full copy of the state should store the state of B<sub>F</sub>.</p><p>For the tree of non-finalized blocks beyond B<sub>F</sub>, the state diff of each block can be held in main memory. As new blocks are finalized, the client applies their diffs to the database, moving the persistent state forward. Storing diffs in memory allows for efficient reorg processing: when the eth2 client detects a reorg from block b<sub>x</sub> to block b<sub>y</sub>, it first determines the common ancestor b<sub>a</sub>. It can then submit all blocks B<sub>a+1</sub>…<!-- -->B<sub>y</sub> for processing. When the eth1 client detects that a block has already been processed because its state is available as a diff in memory, it can skip EVM processing of the block and just move its head state reference to the new block.</p><p>While reorgs below B<sub>F</sub> cannot happen during normal operation of the beacon chain, it may still be necessary to roll back to an earlier state when EVM processing flaws cause the client to deviate from the canonical chain. As a safety net for this exceptional case, we recommend that eth1 clients to maintain a way to manually reorg up to 90,000 blocks (roughly 2 weeks), as this would provide sufficient time to fix issues.</p><p>To make this &#x27;manual intervention reorg&#x27; work, eth1 client can maintain backward diffs in a persistent store. If an intervention is requested, these diffs can be incrementally applied to the state of B<sub>F</sub>, resetting the client to an earlier state.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="issues">Issues<a class="hash-link" href="#issues" title="Direct link to heading">​</a></h2><p>In early review of this scheme, two issues were discovered. Both stem from our misunderstanding of eth2 finalization semantics.</p><p>(1) Since eth2 finalizes blocks only on epoch boundaries, it wants to call final(B) only for epoch blocks. This could be handled a bit better by also using proc(B) in the sync trigger.</p><p>(2) While finalization will work within ~64 blocks in the happy case, it can take up to 2 weeks to finalize in the event of a network partition. Since the maximum number of non-finalized blocks is so much larger than we initially anticipated, it will not be possible to use B<sub>F</sub> as the persistent state block.</p><p>We have decided to tackle this issue in the following way:</p><ul><li>At head H, define the &#x27;calcified&#x27; block B<sub>C</sub> with C = max(H-512, F). This puts an upper bound of 512 blocks on the number of states kept in memory.</li><li>Define that clients should keep the state of B<sub>C</sub> in persistent storage.</li><li>Use B<sub>C</sub> as the initial sync target. This has implications on the sync trigger because the eth1 client can no longer rely on final(B) to start sync (B<sub>C</sub> may be non-final).</li><li>Add a new call *<strong>*reset(B)**</strong> to reset the eth1 client to a historical block. Require that clients must be able to satisfy any reset in range B<sub>F</sub>…<!-- -->B<sub>H</sub>. They will probably have to implement something like the persistent reverse diffs recommended in the reorg section.</li></ul><p>Adding the calcified block also adds some tricky new corner cases and failure modes. In particular, if the eth1 client just performed snap sync, it will not be able to reorg below B<sub>C</sub>, because reverse diffs down to B<sub>F</sub> will not be available. We may solve this by recommending that nodes should attempt snap sync if reset(B) cannot be satisfied. For sure, some nodes will be synced enough to serve the target state. In the absolute worst case, we need to make reverse diffs available for download in snap sync.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/manifoldfinance/kb/tree/trunk/docs/Block-Construction/Block-Sync.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Block-Construction/blockconstruction-message-ordering"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Block Construction</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Block-Construction/Find-Safe-Head"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Finding the Safe Head</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#definitions" class="table-of-contents__link toc-highlight">Definitions</a></li><li><a href="#sync" class="table-of-contents__link toc-highlight">Sync</a><ul><li><a href="#eth2-perspective" class="table-of-contents__link toc-highlight">eth2 perspective</a></li><li><a href="#eth1-perspective" class="table-of-contents__link toc-highlight">eth1 perspective</a></li><li><a href="#handling-restarts-and-errors" class="table-of-contents__link toc-highlight">Handling restarts and errors</a></li></ul></li><li><a href="#reorg-processing-and-state-availability" class="table-of-contents__link toc-highlight">Reorg processing and state availability</a></li><li><a href="#issues" class="table-of-contents__link toc-highlight">Issues</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://t.me/manifoldfinance" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forums.manifoldfinance.coms" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discourse<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/foldfinance" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/manifoldfinance" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Manifold Finance, Inc & CommodityStream, Inc. All Rights Reservved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.e43a89e6.js"></script>
<script src="/assets/js/main.387e3fc9.js"></script>
</body>
</html>